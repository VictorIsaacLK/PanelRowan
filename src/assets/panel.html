<!doctype html>
<html lang="es">
<head>
  <link rel="manifest" href="/assets/manifest.json">
  <meta name="theme-color" content="#e51e2a">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--red:#e51e2a;--dark:#0f172a;--muted:#6b7280;--bg:#f7f8fb;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;color:var(--dark);background:var(--bg)}
    header{background:var(--red);color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px}
    header .header-logout{width:40px;height:40px;border-radius:10px;background:#fff;color:var(--red);border:0;display:grid;place-items:center;cursor:pointer;font-weight:700}
    header .back{font-weight:700}
    header h1{margin:0;font-size:18px;flex:1;text-align:center}
    .container{max-width:1100px;margin:18px auto;padding:12px}
    .toolbar{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .search{flex:1;display:flex;align-items:center;gap:8px}
    .input{padding:10px 12px;border-radius:10px;border:2px solid #e6e6e6;background:#fff;width:100%;}
    .select, .date{padding:10px;border-radius:10px;border:2px solid #e6e6e6;background:#fff}
    .btn{background:var(--red);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 360px}}

    /* tickets list */
    .list{display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);border-radius:12px;padding:12px;border:3px solid rgba(229,30,42,.12);position:relative}
    .card .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .card .meta .id{font-weight:700}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
    .tag.pendiente{background:#ffd6d8;color:var(--red)}
    .tag.revision{background:#fff3bf;color:#d97706}
    .tag.finalizado{background:#d1fae5;color:#16a34a}
    .card p{margin:6px 0;color:#111827}

    .card .actions{display:flex;gap:8px;align-items:center;margin-top:8px}
    .icon-btn{display:inline-grid;place-items:center;width:40px;height:40px;border-radius:10px;background:#fff;border:1px solid rgba(0,0,0,.06);cursor:pointer}
    .icon-pdf{color:#b91c1c}
    .icon-img{color:#b45309}
    .icon-edit{color:#f59e0b}
    .icon-delete{color:#ef4444}

    /* details pane */
    .pane{background:var(--card);border-radius:12px;padding:12px;border:3px solid rgba(229,30,42,.08)}
    .pane h2{margin:0 0 8px;font-size:16px}
    .form-row{display:flex;gap:8px;align-items:center;margin:8px 0}
    .select-sm{padding:8px;border-radius:8px;border:1px solid #e6e6e6}

    footer.pwa-actions{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:4px solid rgba(229,30,42,.12);display:flex;justify-content:center;padding:8px}
    .fab{width:56px;height:56px;border-radius:999px;background:var(--red);display:grid;place-items:center;color:#fff;font-size:28px;border:6px solid #fff;box-shadow:0 6px 18px rgba(0,0,0,.12);}

    .empty{padding:20px;text-align:center;color:var(--muted)}
  </style>
</head>
<script src="/assets/config.js"></script>
<body>
  <header>
    <button id="logoutBtn" class="header-logout" title="Cerrar sesiÃ³n">âŽ‹</button>
    <div class="back">â¬…</div>
    <h1>SEDE â€” Panel Administrador</h1>
    <div style="width:24px"></div>
  </header>

  <main class="container">
    <section class="toolbar">
      <div class="search">
        <input id="q" class="input" placeholder="Buscar por ID, descripciÃ³n, usuario..." />
        <button class="btn" id="searchBtn">Buscar</button>
      </div>
      <select id="filterSistema" class="select">
        <option value="">Todos los sistemas</option>
      </select>
      <select id="filterEdificio" class="select" style="margin-left:8px">
        <option value="">Todos los edificios</option>
      </select>
      <select id="filterRol" class="select" style="margin-left:8px;display:none">
        <option value="">Todos los roles</option>
      </select>
      <div style="display:flex;gap:8px;align-items:center;margin-left:8px">
        <select id="viewSelector" class="select">
          <option value="tickets">Tickets</option>
          <option value="usuarios">Empleados</option>
        </select>
        <!-- <button class="btn" id="exportJsonBtn">Exportar (JSON)</button> -->
        <button class="btn" id="exportViewCsvBtn" style="background:#0f172a">Exportar (CSV)</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="from" type="date" class="date" />
        <input id="to" type="date" class="date" />
      </div>
    </section>

    <div class="grid">
      <section class="list" id="itemsList">
        <!-- List render here -->
      </section>

      <aside class="pane" id="detailPane">
        <h2>Detalles</h2>
        <div id="detailContent" style="min-height:180px">
          <p class="empty">Selecciona para ver detalles.</p>
        </div>
      </aside>
    </div>
  </main>

  <footer class="pwa-actions">
    <button class="fab" id="newTicket">+</button>
  </footer>

  <script>
    // --- Config (read from central /assets/config.js)
    const API_BASE = window.API_BASE_URL || (window.APP_CONFIG && window.APP_CONFIG.API_BASE) || 'http://localhost:3000';

    // --- Helpers
    function el(tag, attrs={}, children=[]){
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') e.className = v; else if(k==='html') e.innerHTML=v; else e.setAttribute(k,v);
      });
      (Array.isArray(children)?children:[children]).flat().forEach(c=>{ if(typeof c==='string') e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c); });
      return e;
    }

    // --- State
    let tiposSistema = [];
    let tickets = [];
    let usuarios = [];
    let roles = [];
    let edificios = [];
    let asignaciones = [];
    let evidencias = [];
    let historial = [];
    let notificaciones = [];

    // --- Fetch initial data (with fallback sample for demo)
    async function init(){
      try{
        // fetch tipos_sistema
        const resS = await fetch(API_BASE + '/tipos-sistema');
        if(resS.ok) tiposSistema = await resS.json();
      }catch(e){ console.warn('No se pudo obtener tipos_sistema, usando demo.'); tiposSistema = [{id:1,nombre:'FAS (Alarma de Incendio)'},{id:2,nombre:'Sistema de Accesos'}]; }

      const sel = document.getElementById('filterSistema');
      tiposSistema.forEach(t=> sel.appendChild(el('option',{value:t.id}, t.nombre)));

      // Fetch additional resources used in the panel so we can export them
      try{ const r = await fetch(API_BASE + '/usuarios'); if(r.ok) usuarios = await r.json(); }catch(e){ console.warn('Usuarios no disponibles'); }
      try{
        // include Authorization header if token present
        const token = localStorage.getItem('token') || '';
        const bearer = token && token.startsWith('Bearer ') ? token : (token ? ('Bearer ' + token) : '');
        const opts = bearer ? { headers: { 'Authorization': bearer } } : {};
        const r = await fetch(API_BASE + '/roles', opts);
        if(r.ok) roles = await r.json();
      }catch(e){ console.warn('Roles no disponibles'); }
      try{ const r = await fetch(API_BASE + '/edificios'); if(r.ok) edificios = await r.json(); }catch(e){ console.warn('Edificios no disponibles'); }
      // populate edificios select
      try{
        const selEd = document.getElementById('filterEdificio');
        if(edificios && Array.isArray(edificios)){
          edificios.forEach(e=> selEd.appendChild(el('option',{value:e.id}, e.nombre)));
        }
      }catch(e){/* ignore */}
      // populate roles select
      try{
        const selRol = document.getElementById('filterRol');
        if(roles && Array.isArray(roles) && selRol){
          roles.forEach(r=> selRol.appendChild(el('option',{value:r.id}, r.nombre)));
        }
      }catch(e){/* ignore */}
      try{ const r = await fetch(API_BASE + '/asignaciones-tickets'); if(r.ok) asignaciones = await r.json(); }catch(e){ console.warn('Asignaciones no disponibles'); }
      try{ const r = await fetch(API_BASE + '/evidencias'); if(r.ok) evidencias = await r.json(); }catch(e){ console.warn('Evidencias no disponibles'); }
      try{ const r = await fetch(API_BASE + '/historial-status'); if(r.ok) historial = await r.json(); }catch(e){ console.warn('Historial no disponible'); }
      try{ const r = await fetch(API_BASE + '/notificaciones'); if(r.ok) notificaciones = await r.json(); }catch(e){ console.warn('Notificaciones no disponibles'); }

      await loadTickets();
    }

    async function loadTickets(){
      const q = document.getElementById('q').value;
      const sistema = document.getElementById('filterSistema').value;
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      try{
        const edificioId = document.getElementById('filterEdificio').value;
        if (edificioId) {
          // If an edificio is selected, use the por-edificio endpoint (returns ticket objects)
          const res = await fetch(API_BASE + '/tickets/por-edificio/' + encodeURIComponent(edificioId));
          if(res.ok){
            let data = await res.json();
            // data is an array of ticket objects; apply client-side sistema filter if present
            if(sistema){ data = data.filter(tt => (tt.tipoSistema?.id || tt.tipo_sistema?.id || (tt.tipoSistema || tt.tipo_sistema)) == Number(sistema)); }
            tickets = data;
            renderList(); return;
          }
        } else {
          // The API exposes all tickets via /asignaciones-tickets (each item has .ticket)
          const params = new URLSearchParams({q, sistema, from, to});
          const url = API_BASE + '/asignaciones-tickets' + (params.toString() ? ('?' + params.toString()) : '');
          const res = await fetch(url);
          if(res.ok){
            let data = await res.json();
            // normalize: many endpoints return { id, ticket: { ... } }
            if(Array.isArray(data) && data.length>0 && data[0].ticket){
              data = data.map(a => {
                const t = a.ticket;
                if(a.empleado) t.usuarioAsignado = a.empleado;
                return t;
              });
            }
            // apply sistema filter client-side: ticket.tipoSistema.id or ticket.tipo_sistema.id
            if(sistema){ data = data.filter(tt => (tt.tipoSistema?.id || tt.tipo_sistema?.id) == Number(sistema)); }
            tickets = data;
            renderList(); return;
          }
        }
      }catch(e){ console.warn('No se pudo cargar tickets, usando demo', e); }


      renderList();
    }

    function renderList(){
      const list = document.getElementById('itemsList'); list.innerHTML='';
      // guard against malformed items (null/undefined) in the tickets array
      const safeTickets = Array.isArray(tickets) ? tickets.filter(x => x && typeof x === 'object') : [];
      if(Array.isArray(tickets) && tickets.length !== safeTickets.length){
        console.warn('renderList: removed', tickets.length - safeTickets.length, 'invalid ticket entries');
      }
      if(safeTickets.length===0){ list.appendChild(el('div',{class:'empty'},'No hay tickets')); return; }
      safeTickets.forEach(t=>{
        const card = el('article',{class:'card'});
        // Support both flat and nested ticket shapes
        const codigo = t.codigo_ticket || t.codigoTicket || '';
        const tipo = (t.tipo_sistema && t.tipo_sistema.nombre) || (t.tipoSistema && t.tipoSistema.nombre) || (t.tipo_sistema || t.tipoSistema) || '';
        const fecha = t.fecha_creacion || t.fechaCreacion || (t.fecha && t.fecha) || '';
        const meta = el('div',{class:'meta'}, [ el('div',{class:'id'}, `${codigo} â€” ${tipo}`), el('div',{}, fecha) ]);
        card.appendChild(meta);
        card.appendChild(el('p',{}, [ el('strong',{}, 'DescripciÃ³n: '), ' ' + (t.descripcion || '') ]));
        // usuarioAsignado / usuario_asignado / asignado
        const asignado = t.usuarioAsignado?.nombre ? (t.usuarioAsignado.nombre + ' ' + (t.usuarioAsignado.apellidos||'')) : (t.asignado || t.usuario_asignado || 'NA');
        card.appendChild(el('p',{}, [ el('strong',{}, 'Asignado a: '), asignado || 'NA' ]));

        const statusVal = t.status || t.estado || 'pendiente';
        const statusTag = el('span',{class:'tag ' + statusVal}, statusVal.charAt(0).toUpperCase() + statusVal.slice(1));
        card.appendChild(statusTag);

        const actions = el('div',{class:'actions'});
        const imgBtn = el('button',{class:'icon-btn',title:'Ver evidencia/imagen'}, 'ðŸ–¼');
        imgBtn.addEventListener('click',()=> openEvidence(t.id));
        const pdfBtn = el('button',{class:'icon-btn',title:'Ver PDF'}, 'ðŸ“„');
        pdfBtn.addEventListener('click',()=> openPDF(t.id));
        const editBtn = el('button',{class:'icon-btn',title:'Cambiar status'}, 'âœï¸');
        editBtn.addEventListener('click',()=> openChangeStatus(t));
        const delBtn = el('button',{class:'icon-btn',title:'Eliminar'}, 'âœ–');
        delBtn.addEventListener('click',()=> deleteTicket(t.id));

        actions.append(imgBtn,pdfBtn,editBtn,delBtn);
        card.appendChild(actions);

        card.addEventListener('click',(ev)=>{ if(ev.target.closest('.icon-btn')) return; showDetail(t); });

        list.appendChild(card);
      });
    }

    // --- Export helpers
    function download(filename, content, mime='application/json'){
      const blob = new Blob([content], { type: mime + ';charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 5000);
    }

    function toCSV(arr){
      if(!Array.isArray(arr) || arr.length===0) return '';
      const keys = Array.from(arr.reduce((s,row)=>{ Object.keys(row).forEach(k=>s.add(k)); return s; }, new Set()));
      const lines = [keys.join(',')];
      for(const row of arr){
        const vals = keys.map(k=>{
          const v = row[k] === undefined || row[k] === null ? '' : String(row[k]);
          // escape quotes
          if(v.indexOf(',')!==-1 || v.indexOf('"')!==-1 || v.indexOf('\n')!==-1) return '"' + v.replace(/"/g,'""') + '"';
          return v;
        });
        lines.push(vals.join(','));
      }
      return lines.join('\n');
    }

    function exportAllAsJson(){
      const payload = { tiposSistema, tickets, usuarios, roles, edificios, asignaciones, evidencias, historial, notificaciones };
      download('export-all-' + new Date().toISOString().replace(/[:.]/g,'-') + '.json', JSON.stringify(payload, null, 2), 'application/json');
    }

    function exportTicketsCsv(){
      const csv = toCSV(tickets);
      if(!csv){ alert('No hay tickets para exportar'); return; }
      download('tickets-' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.csv', csv, 'text/csv');
    }

    function showDetail(t){
      const pane = document.getElementById('detailContent'); pane.innerHTML='';
      pane.appendChild(el('p',{}, [ el('strong',{}, 'ID: '), t.codigo_ticket || '' ]));
      const tipoDetalle = (t.tipo_sistema && t.tipo_sistema.nombre) || (t.tipoSistema && t.tipoSistema.nombre) || (t.tipo_sistema || t.tipoSistema) || '';
      pane.appendChild(el('p',{}, [ el('strong',{}, 'Sistema: '), tipoDetalle ]));
      pane.appendChild(el('p',{}, [ el('strong',{}, 'Fecha: '), t.fecha_creacion || t.fechaCreacion || '' ]));
      pane.appendChild(el('p',{}, [ el('strong',{}, 'DescripciÃ³n:') ]));
      pane.appendChild(el('p',{}, t.descripcion || ''));
      const asignadoDetalle = t.usuarioAsignado?.nombre ? (t.usuarioAsignado.nombre + ' ' + (t.usuarioAsignado.apellidos||'')) : (t.asignado || t.usuario_asignado || 'NA');
      pane.appendChild(el('p',{}, [ el('strong',{}, 'Asignado a: '), asignadoDetalle ]));

      const form = el('div',{}, []);
      const sel = el('select',{class:'select-sm',id:'statusSelect'});
      ['pendiente','revision','finalizado'].forEach(s=> sel.appendChild(el('option',{value:s}, s)));
      sel.value = t.status;
      const btn = el('button',{class:'btn',style:'margin-left:8px'}, 'Guardar status');
      btn.addEventListener('click',()=> changeStatus(t.id, sel.value));

      const assignRow = el('div',{class:'form-row'});
      // create a select populated with usuarios so the user can pick an empleado
      const assignSelect = el('select',{class:'select-sm',id:'assignTo'});
      assignSelect.appendChild(el('option',{value:''}, 'Seleccionar empleado'));
      if(Array.isArray(usuarios)){
        usuarios.forEach(u=>{
          const label = (u.nombre || '') + (u.apellidos ? (' ' + u.apellidos) : '') + (u.rol && u.rol.nombre ? (' â€” ' + u.rol.nombre) : '');
          const opt = el('option',{value: u.id}, label);
          assignSelect.appendChild(opt);
        });
      }
      const assignBtn = el('button',{class:'btn',style:'background:#10b981'}, 'Asignar');
      assignBtn.addEventListener('click',()=> assignTicket(t.id, document.getElementById('assignTo').value));

      form.appendChild(el('div',{class:'form-row'}, [sel, btn]));
      form.appendChild(assignRow);
      form.appendChild(assignSelect); form.appendChild(assignBtn);
      pane.appendChild(form);
    }

    function openEvidence(ticketId){ alert('Abrir modal de evidencia para ticket ' + ticketId + ' (usar cÃ¡mara en PWA mÃ³vil)'); }
    function openPDF(ticketId){ alert('Descargar/Ver PDF del ticket ' + ticketId); }

    async function openChangeStatus(t){
      showDetail(t);
    }

    async function changeStatus(ticketId,newStatus){
      try{
        // find current ticket to get previous status
        const ticket = (tickets || []).find(t => String(t.id) === String(ticketId));
        const prevStatus = ticket?.status || ticket?.estado || '';

        // 1) Update ticket via PUT /tickets/:id (tickets controller expects full update payload)
        const updateRes = await fetch(API_BASE + '/tickets/' + ticketId,{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ status: newStatus })
        });

        if(!updateRes.ok){ alert('Error actualizando status en el ticket'); return; }

        // 2) Create historial record via POST /historial-status
        // Try to get usuario_id from localStorage token or a global var
        let usuarioId = null;
        try{
          const userRaw = localStorage.getItem('user');
          if(userRaw){ const u = JSON.parse(userRaw); usuarioId = u.id || u.usuario_id || u.usuario?.id; }
          if(!usuarioId){
            const token = localStorage.getItem('token');
            if(token){
              const parts = token.split('.');
              if(parts.length>=2){
                const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
                usuarioId = payload.sub || payload.id || payload.userId || payload.usuario?.id;
              }
            }
          }
        }catch(e){ /* ignore parse errors */ }
        if (!usuarioId) usuarioId = undefined;

        const histBody = { ticket_id: Number(ticketId), status_anterior: prevStatus || undefined, status_nuevo: newStatus };
        if (usuarioId !== undefined && usuarioId !== null) {
          histBody.usuario_id = Number(usuarioId);
        }
        await fetch(API_BASE + '/historial-status', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(histBody) });

        alert('Status actualizado');
        await loadTickets();
      }catch(e){ console.error(e); alert('No se pudo conectar al servidor (demo).'); }
    }

    async function assignTicket(ticketId, empleadoId){
      if(!empleadoId){ alert('Selecciona un empleado'); return; }
      try{
        const body = { ticket_id: Number(ticketId), empleado_id: Number(empleadoId) };
        const res = await fetch(API_BASE + '/asignaciones-tickets/asignar', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const txt = await res.text();
        console.log('Asignar response status', res.status, 'body:', txt);
        if(!res.ok){ console.error('Asignar error', res.status, txt); alert('Error al asignar: ' + txt); return; }

        let created;
        try{ created = JSON.parse(txt); }catch(e){ console.warn('No JSON en respuesta asignar, intentando fetch de asignaciones'); }

        // If server returned the created/updated assignment object, use it to update UI
        if(created && created.empleado){
          // Update tickets[]: find the ticket and attach usuarioAsignado
          for(let i=0;i<tickets.length;i++){
            if(String(tickets[i].id) === String(ticketId)){
              tickets[i].usuarioAsignado = created.empleado;
              break;
            }
          }
          showDetail(tickets.find(t=>String(t.id)===String(ticketId)) || { id: ticketId });
          const sel = document.getElementById('assignTo'); if(sel) sel.value = '';
          alert('Ticket asignado');
          return;
        }

        // Fallback: reload tickets and refresh detail
        await loadTickets();
        const updated = (tickets || []).find(t => String(t.id) === String(ticketId));
        if(updated) showDetail(updated);
        const sel = document.getElementById('assignTo'); if(sel) sel.value = '';
        alert('Ticket asignado');
      }catch(e){ console.error(e); alert('Error de red al asignar'); }
    }


    async function deleteTicket(ticketId){ if(!confirm('Eliminar ticket?')) return; try{ const res = await fetch(API_BASE + '/tickets/' + ticketId,{method:'DELETE'}); if(res.ok){ alert('Eliminado'); await loadTickets(); } }catch(e){ alert('Demo: imposible eliminar'); } }

    // --- Events
    document.getElementById('searchBtn').addEventListener('click', ()=> loadView('tickets'));
    document.getElementById('filterSistema').addEventListener('change', ()=> loadView(currentView));
    // reload when edificio changes
    document.getElementById('filterEdificio').addEventListener('change', ()=> loadView(currentView));
    // reload when role changes
    const roleFilterEl = document.getElementById('filterRol');
    if(roleFilterEl) roleFilterEl.addEventListener('change', ()=> loadView(currentView));
    document.getElementById('newTicket').addEventListener('click', ()=> alert('Abrir modal para crear ticket (solo demo)'));
    /* document.getElementById('exportJsonBtn').addEventListener('click', exportCurrentAsJson); */
    document.getElementById('exportViewCsvBtn').addEventListener('click', exportCurrentAsCsv);
    document.getElementById('viewSelector').addEventListener('change', (e)=> loadView(e.target.value));

    // Logout button: call API endpoint then clear local session
    const logoutEl = document.getElementById('logoutBtn');
    if (logoutEl) {
      logoutEl.addEventListener('click', async () => {
        const token = localStorage.getItem('token') || '';
        const bearer = token.startsWith('Bearer ') ? token : ('Bearer ' + token);
        try {
          if (token) {
            const res = await fetch(API_BASE + '/auth-captcha/logout', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': bearer },
              body: JSON.stringify({ token: bearer }),
            });
            if (!res.ok) {
              const txt = await res.text().catch(() => null);
              alert('Error al cerrar sesiÃ³n: ' + (txt || res.status));
              return;
            }
          }
        } catch (e) {
          console.warn('Logout request failed', e);
          alert('No se pudo contactar al servidor. SesiÃ³n local cerrada.');
        } finally {
          // keep existing removals
          try { localStorage.removeItem('token'); localStorage.removeItem('user'); } catch (e) { }
          // also clear other likely session keys
          try {
            ['jwt','refreshToken','fcmToken','session','auth'].forEach(k=>{ try{ localStorage.removeItem(k); }catch(_){} });
          } catch (e) {}
          try { sessionStorage.clear(); } catch (e) {}
          // expire cookies
          try {
            document.cookie.split(';').forEach(cookie => {
              const eqPos = cookie.indexOf('=');
              const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
              document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/';
              document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:00 GMT';
            });
          } catch (e) {}
          // Redirect to index.html (login page)
          window.location.href = '/index.html';
        }
      });
    }

    // iniciar
    // currentView tracks what resource we're showing (tickets, usuarios, roles, etc.)
    let currentView = 'tickets';

    const viewToEndpoint = {
      tickets: '/asignaciones-tickets',
      usuarios: '/usuarios',
      roles: '/roles',
      edificios: '/edificios',
      evidencias: '/evidencias',
      historial: '/historial-status',
      notificaciones: '/notificaciones',
      asignaciones: '/asignaciones-tickets',
    };

    function updateExportButtons(){
      const sel = document.getElementById('viewSelector'); if(sel) sel.value = currentView;
      const csvBtn = document.getElementById('exportViewCsvBtn');
      const jsonBtn = document.getElementById('exportJsonBtn');
      if(csvBtn) csvBtn.textContent = `Exportar ${capitalizeView(currentView)} (CSV)`;
      if(jsonBtn) jsonBtn.textContent = `Exportar ${capitalizeView(currentView)} (JSON)`;
    }

    // Show/hide filters depending on selected view
    function updateFiltersForView(view){
      const sSistema = document.getElementById('filterSistema');
      const sEdificio = document.getElementById('filterEdificio');
      const sRol = document.getElementById('filterRol');
      if(view === 'tickets'){
        if(sSistema) sSistema.style.display = '';
        if(sEdificio) sEdificio.style.display = '';
        if(sRol) sRol.style.display = 'none';
      } else if(view === 'usuarios'){
        if(sSistema) sSistema.style.display = 'none';
        if(sEdificio) sEdificio.style.display = 'none';
        if(sRol) sRol.style.display = '';
      } else {
        // hide filters for other views by default
        if(sSistema) sSistema.style.display = 'none';
        if(sEdificio) sEdificio.style.display = 'none';
        if(sRol) sRol.style.display = 'none';
      }
    }

    function capitalizeView(v){
      if(!v) return '';
      if(v==='usuarios') return 'Empleados';
      if(v==='historial') return 'Historial';
      return v.charAt(0).toUpperCase() + v.slice(1);
    }

    async function loadView(view){
      currentView = view || currentView;
      updateExportButtons();
      updateFiltersForView(currentView);
      try{
        if(currentView === 'tickets'){
          await loadTickets();
          return;
        }

        const endpoint = viewToEndpoint[currentView] || ('/' + currentView);
        const res = await fetch(API_BASE + endpoint);
        if(!res.ok){ console.warn('Error fetching', endpoint); renderGenericList([]); return; }
        const data = await res.json();

        // Special case: /asignaciones-tickets returns objects with .ticket; normalize
        if(Array.isArray(data) && data.length>0 && data[0].ticket){
          const ticketsData = data.map(a=>{ const t = a.ticket; if(a.empleado) t.usuarioAsignado = a.empleado; return t; });
          tickets = ticketsData; renderList(); return;
        }

        if(currentView === 'usuarios'){
          usuarios = Array.isArray(data)? data : (data.rows || []);
          renderUsuarios(); return;
        }

        // generic render for arrays of simple records
        if(Array.isArray(data)){
          renderGenericList(data);
          return;
        }
        // fallback: show single object
        renderGenericList([data]);
      }catch(e){ console.error(e); renderGenericList([]); }
    }

    function renderUsuarios(){
      const list = document.getElementById('itemsList'); list.innerHTML='';
      // Apply role filter if set
      const roleFilter = (document.getElementById('filterRol') && document.getElementById('filterRol').value) || '';
      let data = Array.isArray(usuarios) ? usuarios.slice() : [];
      if(roleFilter){
        data = data.filter(u => {
          if(!u) return false;
          const r = u.rol;
          if(!r) return false;
          if(typeof r === 'object') return String(r.id) === String(roleFilter) || String(r.nombre) === String(roleFilter);
          return String(r) === String(roleFilter);
        });
      }
      if(!Array.isArray(data) || data.length===0){ list.appendChild(el('div',{class:'empty'},'No hay empleados')); return; }
      data.forEach(u=>{
        const card = el('article',{class:'card'});
        const name = (u.nombre||'') + (u.apellidos?(' '+u.apellidos):'');
        const meta = el('div',{class:'meta'}, [ el('div',{class:'id'}, name || ('ID '+(u.id||''))), el('div',{}, u.email || (u.correo || '')) ]);
        card.appendChild(meta);
        card.appendChild(el('p',{}, [ el('strong',{}, 'Rol: '), (u.rol && u.rol.nombre) || u.rol || 'â€”' ]));
        card.appendChild(el('p',{}, [ el('strong',{}, 'TelÃ©fono: '), u.telefono || u.telefono_movil || 'â€”' ]));
        // clicking a usuario shows the usuario detail pane where role can be changed
        card.addEventListener('click', (ev)=>{ if(ev.target.closest('.icon-btn')) return; showUsuarioDetail(u); });
        list.appendChild(card);
      });
    }

    // Show detail pane for a usuario and allow changing role
    function showUsuarioDetail(u){
      const pane = document.getElementById('detailContent'); pane.innerHTML='';
      if(!u) { pane.appendChild(el('p',{class:'empty'},'Usuario no disponible')); return; }
      const name = (u.nombre||'') + (u.apellidos?(' '+u.apellidos):'');
      pane.appendChild(el('p',{}, [ el('strong',{}, 'Nombre: '), name || ('ID '+(u.id||'')) ]));
      pane.appendChild(el('p',{}, [ el('strong',{}, 'Email: '), u.email || u.correo || 'â€”' ]));
      pane.appendChild(el('p',{}, [ el('strong',{}, 'TelÃ©fono: '), u.telefono || u.telefono_movil || 'â€”' ]));

      // role selector
      const row = el('div',{class:'form-row'});
      const roleSel = el('select',{class:'select-sm',id:'detailRoleSelect'});
      roleSel.appendChild(el('option',{value:''}, 'Seleccionar rol'));
      // populate roles (prefer fresh fetch to avoid stale/duplicated data)
      const dedupeRoles = (list)=>{
        const m = new Map();
        (Array.isArray(list)?list:[]).forEach(r=>{
          const key = (r && (r.id || r.nombre)) ? (r.id !== undefined ? String(r.id) : String(r.nombre)) : JSON.stringify(r);
          if(!m.has(key)) m.set(key, r);
        });
        return Array.from(m.values());
      };

      const populateRoles = (rolesList)=>{
        // clear existing
        roleSel.innerHTML = '';
        roleSel.appendChild(el('option',{value:''}, 'Seleccionar rol'));
        const unique = dedupeRoles(rolesList);
        unique.forEach(r=>{
          // ensure option text and value exist
          const id = (r && (r.id !== undefined)) ? r.id : r.nombre || r;
          const nombre = (r && r.nombre) ? r.nombre : String(r);
          const opt = el('option',{value:id}, nombre);
          roleSel.appendChild(opt);
        });

        // preselect current role if present (try id then nombre)
        try{
          const curId = u.rol && (u.rol.id || u.rol) ? String(u.rol.id || u.rol) : '';
          if(curId){
            // if option with this value exists, select it
            const found = Array.from(roleSel.options).some(o=> o.value === curId);
            if(found) { roleSel.value = curId; return; }
          }
          // fallback: try matching by role name
          const curName = u.rol && u.rol.nombre ? String(u.rol.nombre) : '';
          if(curName){
            const optByName = Array.from(roleSel.options).find(o=> o.textContent === curName);
            if(optByName) roleSel.value = optByName.value;
          }
        }catch(e){ console.warn('Error preselecting role', e); }
      };

      // Always try to fetch fresh roles to avoid duplicates/stale data
      // normalize token and include Authorization header if available
      const __token_for_roles = localStorage.getItem('token') || '';
      const __bearer_for_roles = __token_for_roles && __token_for_roles.startsWith('Bearer ') ? __token_for_roles : (__token_for_roles ? ('Bearer ' + __token_for_roles) : '');
      (async ()=>{
        try{
          const opts = __bearer_for_roles ? { headers: { 'Authorization': __bearer_for_roles } } : {};
          const r = await fetch(API_BASE + '/roles', opts);
          if(r.ok){
            const rr = await r.json();
            const fetched = Array.isArray(rr) ? rr : (rr.rows || []);
            roles = dedupeRoles(fetched);
            populateRoles(roles);
            return;
          }
        }catch(e){ console.warn('No se pudieron cargar roles desde el servidor', e); }
        // fallback to existing roles array if fetch failed
        try{ populateRoles(roles || []); }catch(e){ /* ignore */ }
      })();

      const saveBtn = el('button',{class:'btn',style:'margin-left:8px'}, 'Guardar rol');
      saveBtn.addEventListener('click', async ()=>{
        const selVal = roleSel.value;
        if(!selVal){ alert('Selecciona un rol'); return; }
        // find role name from roles array
        const selRole = (roles||[]).find(r=> String(r.id)===String(selVal)) || { id: selVal, nombre: roleSel.options[roleSel.selectedIndex]?.text || '' };
        // disable UI while request runs
        saveBtn.disabled = true;
        const prevText = saveBtn.textContent;
        saveBtn.textContent = 'Guardando...';
        try{
          // include Authorization header if token exists
          const tokenForReq = localStorage.getItem('token') || '';
          const bearerForReq = tokenForReq && tokenForReq.startsWith('Bearer ') ? tokenForReq : (tokenForReq ? ('Bearer ' + tokenForReq) : '');
          const headers = { 'Content-Type': 'application/json' };
          if(bearerForReq) headers['Authorization'] = bearerForReq;

          const res = await fetch(API_BASE + '/usuarios/' + encodeURIComponent(u.id), {
            method: 'PUT',
            headers,
            body: JSON.stringify({ rol_id: Number(selRole.id) })
          });

          if(!res.ok){ const txt = await res.text().catch(()=>null); alert('Error al cambiar rol: ' + (txt || res.status)); return; }

          // prefer using server response (updated user) to keep local state consistent
          let updatedUser = null;
          try{ updatedUser = await res.json(); }catch(e){ /* no json response */ }
          if(updatedUser && updatedUser.id !== undefined){
            // replace or update the user in usuarios array
            let found = false;
            for(let i=0;i<usuarios.length;i++){
              if(String(usuarios[i].id)===String(updatedUser.id)){
                usuarios[i] = updatedUser;
                found = true; break;
              }
            }
            if(!found) usuarios.push(updatedUser);
            alert('Rol actualizado');
            showUsuarioDetail(updatedUser);
            renderUsuarios();
            return;
          }

          // If server didn't return the updated user, fallback to update local rol field
          for(let i=0;i<usuarios.length;i++){
            if(String(usuarios[i].id)===String(u.id)){
              usuarios[i].rol = { id: selRole.id, nombre: selRole.nombre };
              break;
            }
          }
          alert('Rol actualizado');
          showUsuarioDetail(usuarios.find(x=>String(x.id)===String(u.id)) || u);
          renderUsuarios();
        }catch(e){ console.error(e); alert('Error de red al cambiar rol'); }
        finally{ saveBtn.disabled = false; saveBtn.textContent = prevText; }
      });

      row.appendChild(roleSel); row.appendChild(saveBtn);
      pane.appendChild(row);
    }

    function exportCurrentAsJson(){
      (async ()=>{
        try{
          if(currentView === 'tickets'){ exportAllAsJson(); return; }
          const endpoint = viewToEndpoint[currentView] || ('/' + currentView);
          const res = await fetch(API_BASE + endpoint);
          if(!res.ok){ alert('Error exportando ' + currentView); return; }
          const data = await res.json();
          download(currentView + '-' + new Date().toISOString().replace(/[:.]/g,'-') + '.json', JSON.stringify(data, null, 2), 'application/json');
        }catch(e){ console.error(e); alert('Error exportando'); }
      })();
    }

    function exportCurrentAsCsv(){
      (async ()=>{
        try{
          if(currentView === 'tickets'){
            exportTicketsCsv(); return;
          }
          const endpoint = viewToEndpoint[currentView] || ('/' + currentView);
          const res = await fetch(API_BASE + endpoint);
          if(!res.ok){ alert('Error exportando ' + currentView); return; }
          const data = await res.json();
          // normalize if endpoint returns wrapper
          const arr = Array.isArray(data) ? data : (data.rows || [data]);
          const csv = toCSV(arr);
          if(!csv){ alert('No hay datos'); return; }
          download(currentView + '-' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.csv', csv, 'text/csv');
        }catch(e){ console.error(e); alert('Error exportando'); }
      })();
    }

    // start with selected view
    updateExportButtons();
    init().then(()=> loadView(currentView));

    // --- Service worker registration (basic)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW registrado')).catch(()=>console.warn('SW no registrado'));
    }

    // init on load
    window.addEventListener('load', ()=>{ init().catch(e=>console.error(e)); });
  </script>
</body>
</html>
